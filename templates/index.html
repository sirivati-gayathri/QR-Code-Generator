<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator & Decryptor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="column">
            <div class="container">
                <h1>Generate QR Code</h1>
                <div class="form-group">
                    <button type="button" id="random-fill-btn" class="secondary-btn">Fill with Random Data</button>
                </div>
                <form id="generate-form">
                    <div class="form-group">
                        <label for="board_id">Board ID (8-char Hex) *</label>
                        <input type="text" id="board_id" name="board_id" required maxlength="8" pattern="[0-9a-fA-F]{8}" title="8 hexadecimal characters">
                    </div>
                    <div class="form-group">
                        <label for="number_of_relays">Number of Relays (max 8 digits)</label>
                        <input type="number" id="number_of_relays" name="number_of_relays" min="0" max="99999999" oninput="if (this.value.length > 8) this.value = this.value.slice(0, 8);">
                    </div>
                    <div id="relay-id-container"></div>
                    <div class="form-group">
                        <label for="version_number">Version Number (max 8 chars)</label>
                        <input type="text" id="version_number" name="version_number" maxlength="8">
                    </div>
                    <div class="form-group">
                        <label for="build_number">Build Number (max 8 digits)</label>
                        <input type="number" id="build_number" name="build_number" min="0" max="99999999" oninput="if (this.value.length > 8) this.value = this.value.slice(0, 8);">
                    </div>
                    <hr>
                    <h3>Additional Features</h3>
                    <div id="additional-features-container"></div>
                    <button type="button" id="add-feature-btn" class="secondary-btn">Add Feature</button>
                    <hr>
                    <button type="button" id="generate-btn" class="primary-btn">Generate QR Code</button>
                </form>
                <div id="qr-result-container"></div>
            </div>
        </div>

        <div class="column">
            <div class="container">
                <h1>Decrypt Data</h1>
                <p>Scan a QR code with the camera or paste the data below.</p>
                <button type="button" id="scan-qr-btn" class="secondary-btn">üì∑ Open Cam to Scan QR</button>
                <div id="scanner-container">
                    <video id="video-feed" playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div id="loading-message">Loading video stream...</div>
                </div>
                <form id="decrypt-form">
                    <div class="form-group">
                        <label for="encrypted_text">Encrypted Text</label>
                        <textarea id="encrypted_text" name="encrypted_text" rows="6" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="secret_key">Secret Key</label>
                        <input type="password" id="secret_key" name="secret_key" required>
                    </div>
                    <button type="submit" class="primary-btn">Decrypt Data</button>
                </form>
                <div id="decryption-result"></div>
            </div>
        </div>
    </div>

    <script>
        // --- All JavaScript for the page ---
        
        // --- Part 1: Generator Logic ---
        const generateForm = document.getElementById('generate-form');
        const generateBtn = document.getElementById('generate-btn');
        const qrResultContainer = document.getElementById('qr-result-container');
        const numRelaysInput = document.getElementById('number_of_relays');
        const relayIdContainer = document.getElementById('relay-id-container');

        generateBtn.addEventListener('click', function() {
            const formData = new FormData(generateForm);
            qrResultContainer.innerHTML = `<p>Generating...</p>`;

            fetch("{{ url_for('generate_qr') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    qrResultContainer.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                } else if (data.success) {
                    const qrImageUrl = `{{ url_for('get_qr_code', filename='') }}${data.qr_filename}`;
                    qrResultContainer.innerHTML = `
                        <hr>
                        <h3>Generated QR Code for ${data.board_id}</h3>
                        <img src="${qrImageUrl}" alt="QR Code" width="250">
                        <a href="${qrImageUrl}" download="${data.qr_filename}" class="secondary-btn" style="text-decoration: none; display: block; text-align: center; margin-top: 10px;">
                            ‚¨áÔ∏è Download QR Code
                        </a>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                qrResultContainer.innerHTML = `<div class="alert alert-error">An unexpected error occurred.</div>`;
            });
        });

        function generateRandomHex(length) { return Array.from(window.crypto.getRandomValues(new Uint8Array(length/2)), byte => byte.toString(16).padStart(2,'0')).join(''); }

        numRelaysInput.addEventListener('input', function() { /* ... Relay generation logic as before ... */ });
        document.getElementById('add-feature-btn').addEventListener('click', function() { /* ... Add feature logic as before ... */ });
        document.getElementById('random-fill-btn').addEventListener('click', function() { /* ... Random fill logic as before ... */ });

        // Helper functions for random fill and dynamic fields (pasted for completeness)
        numRelaysInput.addEventListener('input', function() {
            relayIdContainer.innerHTML = '';
            const count = parseInt(this.value, 10);
            if (isNaN(count) || count <= 0) return;
            const listLabel = document.createElement('label');
            listLabel.textContent = 'Relay IDs (16-char Hex)';
            listLabel.className = 'relay-list-label';
            relayIdContainer.appendChild(listLabel);
            for (let i=0; i < count; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'form-group relay-input-group';
                inputGroup.innerHTML = `<input type="text" name="relay_id[]" value="${generateRandomHex(16)}" required maxlength="16" pattern="[0-9a-fA-F]{16}" title="16 hexadecimal characters">`;
                relayIdContainer.appendChild(inputGroup);
            }
        });
        document.getElementById('add-feature-btn').addEventListener('click', function() {
            const container = document.getElementById('additional-features-container');
            const featureDiv = document.createElement('div');
            featureDiv.className = 'feature-group';
            featureDiv.innerHTML = `<input type="text" name="feature_key[]" placeholder="Feature Name"><input type="text" name="feature_value[]" placeholder="Feature Value"><button type="button" class="remove-btn" onclick="removeFeature(this)">Remove</button>`;
            container.appendChild(featureDiv);
        });
        function removeFeature(button) { button.parentElement.remove(); }
        document.getElementById('random-fill-btn').addEventListener('click', function() {
            const btn = this;
            btn.textContent = 'Generating...';
            btn.disabled = true;
            fetch("{{ url_for('get_random_unique_data') }}").then(response => response.json()).then(data => {
                if (data.error) { alert(data.error); return; }
                document.getElementById('board_id').value = data.board_id;
                document.getElementById('number_of_relays').value = data.number_of_relays;
                document.getElementById('version_number').value = data.version_number;
                document.getElementById('build_number').value = data.build_number;
                numRelaysInput.dispatchEvent(new Event('input'));
                setTimeout(() => { document.querySelectorAll('input[name="relay_id[]"]').forEach((input, index) => { input.value = data.relay_ids[index]; }); }, 50);
                const additionalFeaturesContainer = document.getElementById('additional-features-container');
                additionalFeaturesContainer.innerHTML = '';
                for (const key in data.additional_features) {
                    const value = data.additional_features[key];
                    const featureDiv = document.createElement('div');
                    featureDiv.className = 'feature-group';
                    featureDiv.innerHTML = `<input type="text" name="feature_key[]" value="${key}"><input type="text" name="feature_value[]" value="${value}"><button type="button" class="remove-btn" onclick="removeFeature(this)">Remove</button>`;
                    additionalFeaturesContainer.appendChild(featureDiv);
                }
            }).catch(error => alert('Could not fetch random data.'))
            .finally(() => { btn.textContent = 'Fill with Random Data'; btn.disabled = false; });
        });


        // --- Part 2: Decryptor Logic (Scanner and Form) ---
        const scanBtn = document.getElementById('scan-qr-btn');
        const scannerContainer = document.getElementById('scanner-container');
        const video = document.getElementById('video-feed');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const loadingMessage = document.getElementById('loading-message');
        const encryptedTextArea = document.getElementById('encrypted_text');
        const secretKeyInput = document.getElementById('secret_key');
        const decryptForm = document.getElementById('decrypt-form');
        const resultDiv = document.getElementById('decryption-result');
        let stream = null;

        function drawLine(begin, end, color) { /* ... drawLine function as before ... */ }
        function tick() { /* ... tick function as before ... */ }
        scanBtn.addEventListener('click', function() { /* ... scanBtn listener as before ... */ });
        decryptForm.addEventListener('submit', function(event) { /* ... decryptForm listener as before ... */ });

        // Helper functions for decryptor (pasted for completeness)
        function drawLine(begin, end, color) {
            canvas.beginPath(); canvas.moveTo(begin.x, begin.y); canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4; canvas.strokeStyle = color; canvas.stroke();
        }
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                loadingMessage.hidden = true;
                canvasElement.height = video.videoHeight; canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) {
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#00FF00");
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#00FF00");
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#00FF00");
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#00FF00");
                    encryptedTextArea.value = code.data;
                    secretKeyInput.focus();
                    stream.getTracks().forEach(track => track.stop());
                    scannerContainer.style.display = 'none';
                    stream = null; scanBtn.textContent = 'üì∑ Open Cam to Scan QR';
                    return;
                }
            }
            if (stream) { requestAnimationFrame(tick); }
        }
        scanBtn.addEventListener('click', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                scannerContainer.style.display = 'none'; stream = null;
                scanBtn.textContent = 'üì∑ Open Cam to Scan QR';
                return;
            }
            scanBtn.textContent = 'üì∑ Closing Camera...';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(cameraStream) {
                stream = cameraStream;
                scannerContainer.style.display = 'block'; video.srcObject = stream; video.play();
                requestAnimationFrame(tick);
                scanBtn.textContent = 'üì∑ Close Camera';
            }).catch(function(err) {
                alert("Could not access the camera.");
                scanBtn.textContent = 'üì∑ Open Cam to Scan QR';
            });
        });
        decryptForm.addEventListener('submit', function(event) {
            event.preventDefault();
            fetch("{{ url_for('decrypt_data') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ encrypted_text: encryptedTextArea.value, secret_key: secretKeyInput.value }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                } else if (data.data) {
                    const formattedJson = JSON.stringify(data.data, null, 4);
                    resultDiv.innerHTML = `<hr><h2>Decryption Result:</h2><div class="results-box"><pre>${formattedJson}</pre></div>`;
                }
            })
            .catch(error => { resultDiv.innerHTML = `<div class="alert alert-error">An unexpected error occurred.</div>`; });
        });
    </script>
</body>
</html>

